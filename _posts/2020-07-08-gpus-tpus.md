---
layout: post
title: Deep Learning Hardware and TPU Credits
author: Twin Karmakharm
slug: 2020-07-08-git-github-remote
date: 2020-07-08 12:00:00 UTC
tags: 
category:
link:
description:
type: text
---


# Hardware for DL training
DL training hardware
Architecture

Matrix multiplication

TPUs

GPUs

# Trying out TPU with google Colab

Even better, you can use a Cloud TPU for free right now via Colab - just follow the link below!
 
https://colab.research.google.com/notebooks/tpu.ipynb

Be sure to visit Edit > Notebook settings and select TPU before you start running the cells. If you run into trouble, please try Runtime > Restart runtime and let us know if the problem persists.

# Google Cloud and TPU credits

TPU Credits
Trial for 90 days

## Getting TPU credits

Getting credits contact [tfrc-support@google.com](tfrc-support@google.com)


## The Google Cloud Console

* Get to the dashboard [https://console.cloud.google.com](https://console.cloud.google.com)
  universities accounts may already have this, 
  if you use google app scripts e.g. for automating your google docs
* Create and select a project
* Use the built-in cloud shell

TPUs reserved with 


Google cloud
https://cloud.google.com/tpu/docs/quickstart


![project](/asssets/images/2020-08-gpus-tpus/project.png)

 
```
export PROJECT_ID=tputest-275612
export COMPUTE_ZONE=europe-west4-a

# Set default project and zone first
gcloud config set project $PROJECT_ID
gcloud config set compute/zone $COMPUTE_ZONE

# Created a bucket
gsutil mb -c standard -b on gs://tpubeurtwin

#Create a tpu instance
ctpu up --tf-version=2.1 --name=tpu-quickstart

# SSH into the tpu instance
gcloud compute ssh tpu-quickstart

#A new ssh key will be created and you'll be prompted to enter an optional passpharase

# On vm
export STORAGE_BUCKET=gs://tpubeurtwin
export TPU_NAME=tpu-quickstart
export MODEL_DIR=$STORAGE_BUCKET/mnist
DATA_DIR=$STORAGE_BUCKET/data
export PYTHONPATH="$PYTHONPATH:/usr/share/models"

cd /usr/share/models/official/vision/image_classification
python3 mnist_main.py \
  --tpu=$TPU_NAME \
  --model_dir=$MODEL_DIR \
  --data_dir=$DATA_DIR \
  --train_epochs=10 \
  --distribution_strategy=tpu \
  --download

ctpu delete --name=tpu-quickstart


```

Doing readwrite to bucket with gsutil
https://cloud.google.com/storage/docs/quickstart-gsutil
```
gsutil 
# -b is bucket level access https://cloud.google.com/storage/docs/uniform-bucket-level-access
# -l location, different from compute code
gsutil mb -b on -l us-east1 gs://my-awesome-bucket/
ls gs://bucket
cp
rm
```

# Installing your own software stack

Runs on 
Debian 10 (Buster)

Pre-installed
python3
pip3.7


# Using gcloud on your own terminal
```
#Add the Cloud SDK distribution URI as a package source
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list

# Make sure we have these installed
sudo apt-get install apt-transport-https ca-certificates gnupg

#Import google cloud public key
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -

#Update and install the Cloud SDK
sudo apt-get update && sudo apt-get install google-cloud-sdk

* gcloud init
* provides a link
* follow the link with browser, login to the appropriate account
* paste the link into 

```

```
# Actually connect to cloud shell
gcloud alpha cloud-shell ssh
```



```
I0721 16:31:50.956557 140291661145920 discovery.py:280] URL being requested: GET https://www.googleapis.com/discovery/v1/apis/tpu/v1/rest
I0721 16:31:50.993300 140291661145920 discovery.py:911] URL being requested: GET https://tpu.googleapis.com/v1/projects/tputest-275612/locations/us-central1-f/nodes/tpu-quickstart?alt=json
I0721 16:31:50.993529 140291661145920 transport.py:157] Attempting refresh to obtain initial access_token
I0721 16:31:51.063991 140291661145920 discovery.py:280] URL being requested: GET https://www.googleapis.com/discovery/v1/apis/tpu/v1/rest
I0721 16:31:51.092449 140291661145920 discovery.py:911] URL being requested: GET https://tpu.googleapis.com/v1/projects/tputest-275612/locations/us-central1-f/nodes/tpu-quickstart?alt=json
I0721 16:31:51.092670 140291661145920 transport.py:157] Attempting refresh to obtain initial access_token
I0721 16:31:51.163975 140291661145920 discovery.py:280] URL being requested: GET https://www.googleapis.com/discovery/v1/apis/tpu/v1/rest
I0721 16:31:51.192748 140291661145920 discovery.py:911] URL being requested: GET https://tpu.googleapis.com/v1/projects/tputest-275612/locations/us-central1-f/nodes/tpu-quickstart?alt=json
I0721 16:31:51.192975 140291661145920 transport.py:157] Attempting refresh to obtain initial access_token
I0721 16:31:51.281131 140291661145920 discovery.py:280] URL being requested: GET https://www.googleapis.com/discovery/v1/apis/tpu/v1/rest
I0721 16:31:51.309501 140291661145920 discovery.py:911] URL being requested: GET https://tpu.googleapis.com/v1/projects/tputest-275612/locations/us-central1-f/nodes/tpu-quickstart?alt=json
I0721 16:31:51.309729 140291661145920 transport.py:157] Attempting refresh to obtain initial access_token
I0721 16:31:51.361196 140291661145920 remote.py:177] Entering into master device scope: /job:worker/replica:0/task:0/device:CPU:0
2020-07-21 16:31:51.361690: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
2020-07-21 16:31:51.367427: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2300000000 Hz
2020-07-21 16:31:51.367739: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x5295de0 initialized for platform Host (this does not guarantee that XLA will be used). Devices:
2020-07-21 16:31:51.367885: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): Host, Default Version
2020-07-21 16:31:51.373852: I tensorflow/core/distributed_runtime/rpc/grpc_channel.cc:300] Initialize GrpcChannelCache for job worker -> {0 -> 10.240.1.2:8470}
2020-07-21 16:31:51.373901: I tensorflow/core/distributed_runtime/rpc/grpc_channel.cc:300] Initialize GrpcChannelCache for job localhost -> {0 -> localhost:48784}
2020-07-21 16:31:51.390618: I tensorflow/core/distributed_runtime/rpc/grpc_channel.cc:300] Initialize GrpcChannelCache for job worker -> {0 -> 10.240.1.2:8470}
2020-07-21 16:31:51.390678: I tensorflow/core/distributed_runtime/rpc/grpc_channel.cc:300] Initialize GrpcChannelCache for job localhost -> {0 -> localhost:48784}
2020-07-21 16:31:51.391359: I tensorflow/core/distributed_runtime/rpc/grpc_server_lib.cc:390] Started server with target: grpc://localhost:48784
INFO:tensorflow:Initializing the TPU system: tpu-quickstart
I0721 16:31:51.392901 140291661145920 tpu_strategy_util.py:72] Initializing the TPU system: tpu-quickstart
INFO:tensorflow:Clearing out eager caches
I0721 16:31:51.583874 140291661145920 tpu_strategy_util.py:100] Clearing out eager caches
INFO:tensorflow:Finished initializing TPU system.
I0721 16:32:02.127278 140291661145920 tpu_strategy_util.py:123] Finished initializing TPU system.
I0721 16:32:02.128766 140291661145920 discovery.py:280] URL being requested: GET https://www.googleapis.com/discovery/v1/apis/tpu/v1/rest
I0721 16:32:02.157984 140291661145920 discovery.py:911] URL being requested: GET https://tpu.googleapis.com/v1/projects/tputest-275612/locations/us-central1-f/nodes/tpu-quickstart?alt=json
I0721 16:32:02.158308 140291661145920 transport.py:157] Attempting refresh to obtain initial access_token
I0721 16:32:02.222700 140291661145920 discovery.py:280] URL being requested: GET https://www.googleapis.com/discovery/v1/apis/tpu/v1/rest
I0721 16:32:02.252809 140291661145920 discovery.py:911] URL being requested: GET https://tpu.googleapis.com/v1/projects/tputest-275612/locations/us-central1-f/nodes/tpu-quickstart?alt=json
I0721 16:32:02.253087 140291661145920 transport.py:157] Attempting refresh to obtain initial access_token
INFO:tensorflow:Found TPU system:
I0721 16:32:02.306185 140291661145920 tpu_system_metadata.py:140] Found TPU system:
INFO:tensorflow:*** Num TPU Cores: 8
I0721 16:32:02.306554 140291661145920 tpu_system_metadata.py:141] *** Num TPU Cores: 8
INFO:tensorflow:*** Num TPU Workers: 1
I0721 16:32:02.306840 140291661145920 tpu_system_metadata.py:142] *** Num TPU Workers: 1
INFO:tensorflow:*** Num TPU Cores Per Worker: 8
I0721 16:32:02.307316 140291661145920 tpu_system_metadata.py:144] *** Num TPU Cores Per Worker: 8
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:CPU:0, CPU, 0, 0)
I0721 16:32:02.307590 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:CPU:0, CPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:XLA_CPU:0, XLA_CPU, 0, 0)
I0721 16:32:02.307910 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:XLA_CPU:0, XLA_CPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:CPU:0, CPU, 0, 0)
I0721 16:32:02.308095 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:CPU:0, CPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:0, TPU, 0, 0)
I0721 16:32:02.308268 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:0, TPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:1, TPU, 0, 0)
I0721 16:32:02.308435 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:1, TPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:2, TPU, 0, 0)
I0721 16:32:02.308610 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:2, TPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:3, TPU, 0, 0)
I0721 16:32:02.308779 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:3, TPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:4, TPU, 0, 0)
I0721 16:32:02.308962 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:4, TPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:5, TPU, 0, 0)
I0721 16:32:02.309177 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:5, TPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:6, TPU, 0, 0)
I0721 16:32:02.309315 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:6, TPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:7, TPU, 0, 0)
I0721 16:32:02.309453 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:7, TPU, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU_SYSTEM:0, TPU_SYSTEM, 0, 0)
I0721 16:32:02.309655 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU_SYSTEM:0, TPU_SYSTEM, 0, 0)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:XLA_CPU:0, XLA_CPU, 0, 0)
I0721 16:32:02.309836 140291661145920 tpu_system_metadata.py:146] *** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:XLA_CPU:0, XLA_CPU, 0, 0)
I0721 16:32:02.526555 140291661145920 dataset_builder.py:184] Overwrite dataset info from restored data version.
I0721 16:32:02.889069 140291661145920 dataset_builder.py:253] Reusing dataset mnist (gs://tpubeurtwin/data/mnist/1.0.0)
I0721 16:32:02.889521 140291661145920 dataset_builder.py:399] Constructing tf.data.Dataset for split ['train', 'test'], from gs://tpubeurtwin/data/mnist/1.0.0
W0721 16:32:02.928727 140291661145920 dataset_builder.py:439] Warning: Setting shuffle_files=True because split=TRAIN and shuffle_files=None. This behavior will be deprecated on 2019-08-06, at which point shuffle_files=False will be the default for all splits.
Train for 58 steps, validate for 9 steps
Epoch 1/10
2020-07-21 16:32:09.770721: I tensorflow/core/profiler/lib/profiler_session.cc:225] Profiler session started.
 1/58 [..............................] - ETA: 4:50 - loss: 2.2993 - sparse_categorical_accuracy: 0.1104WARNING:tensorflow:Method (on_train_batch_end) is slow compared to the batch update (0.434265). Check your callbacks.
W0721 16:32:10.540239 140291661145920 callbacks.py:248] Method (on_train_batch_end) is slow compared to the batch update (0.434265). Check your callbacks.
58/58 [==============================] - 16s 282ms/step - loss: 1.5783 - sparse_categorical_accuracy: 0.5155 - val_loss: 0.6205 - val_sparse_categorical_accuracy: 0.8141
Epoch 2/10
58/58 [==============================] - 8s 146ms/step - loss: 0.4643 - sparse_categorical_accuracy: 0.8560 - val_loss: 0.2988 - val_sparse_categorical_accuracy: 0.9100
Epoch 3/10
58/58 [==============================] - 8s 143ms/step - loss: 0.2950 - sparse_categorical_accuracy: 0.9104 - val_loss: 0.2093 - val_sparse_categorical_accuracy: 0.9403
Epoch 4/10
58/58 [==============================] - 10s 165ms/step - loss: 0.2319 - sparse_categorical_accuracy: 0.9303 - val_loss: 0.1724 - val_sparse_categorical_accuracy: 0.9488
Epoch 5/10
58/58 [==============================] - 8s 138ms/step - loss: 0.1908 - sparse_categorical_accuracy: 0.9433 - val_loss: 0.1387 - val_sparse_categorical_accuracy: 0.9589
Epoch 6/10
58/58 [==============================] - 9s 149ms/step - loss: 0.1682 - sparse_categorical_accuracy: 0.9498 - val_loss: 0.1253 - val_sparse_categorical_accuracy: 0.9615
Epoch 7/10
58/58 [==============================] - 8s 136ms/step - loss: 0.1436 - sparse_categorical_accuracy: 0.9563 - val_loss: 0.1101 - val_sparse_categorical_accuracy: 0.9667
Epoch 8/10
58/58 [==============================] - 8s 134ms/step - loss: 0.1291 - sparse_categorical_accuracy: 0.9621 - val_loss: 0.1030 - val_sparse_categorical_accuracy: 0.9703
Epoch 9/10
58/58 [==============================] - 8s 137ms/step - loss: 0.1249 - sparse_categorical_accuracy: 0.9624 - val_loss: 0.0916 - val_sparse_categorical_accuracy: 0.9710
Epoch 10/10
58/58 [==============================] - 8s 140ms/step - loss: 0.1114 - sparse_categorical_accuracy: 0.9657 - val_loss: 0.0809 - val_sparse_categorical_accuracy: 0.9755
2020-07-21 16:33:36.118414: W tensorflow/python/util/util.cc:319] Sets are not currently considered sequences, but this may change in the future, so consider avoiding using them.
WARNING:tensorflow:From /usr/local/lib/python3.7/dist-packages/tensorflow_core/python/ops/resource_variable_ops.py:1786: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
Instructions for updating:
If using Keras pass *_constraint arguments to layers.
W0721 16:33:36.216432 140291661145920 deprecation.py:506] From /usr/local/lib/python3.7/dist-packages/tensorflow_core/python/ops/resource_variable_ops.py:1786: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
Instructions for updating:
If using Keras pass *_constraint arguments to layers.
INFO:tensorflow:Assets written to: gs://tpubeurtwin/mnist/saved_model/assets
I0721 16:33:36.505464 140291661145920 builder_impl.py:775] Assets written to: gs://tpubeurtwin/mnist/saved_model/assets
9/9 - 1s - loss: 0.0809 - sparse_categorical_accuracy: 0.9755
I0721 16:33:43.113899 140291661145920 mnist_main.py:165] Run stats:
{'accuracy_top_1': 0.9754774570465088, 'eval_loss': 0.08089065220620897, 'loss': 0.11138931918760826, 'training_accuracy_top_1': 0.965668797492981}
```
